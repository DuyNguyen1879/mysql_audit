<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SQL编辑界面</title>
    <link href={{ url_for('static', filename='css/bootstrap.css') }} rel="stylesheet" type="text/css">
    <script src={{ url_for("static", filename="jquery/jquery.min.js") }} type="text/javascript"></script>
    <script src={{ url_for("static", filename="js/bootstrap.min.js") }} type="text/javascript"></script>
    <script src={{ url_for("static", filename="js/common.js") }} type="text/javascript"></script>

    <script src={{ url_for("static", filename="js/bootstrap-select.js") }} type="text/javascript"></script>
    <link href={{ url_for('static', filename='css/bootstrap-select.css') }} rel="stylesheet" type="text/css">

    <style type="text/css">
        pre {
            border: 0px;
            background: none;
            font-size: 13px;
            margin: 0 0 0px;
            padding: 0px;
            white-space: pre-wrap;
        }

        textarea {
            font-size: 14px;
            font-family: 'Consolas', 'Deja Vu Sans Mono', 'Bitstream Vera Sans Mono', monospace;
        }

        body, td, th, div {
            font-family: 'Consolas', 'Deja Vu Sans Mono', 'Bitstream Vera Sans Mono', monospace, sans-serif;
        }

        .col-center-block {
            float: none;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
<div class="container-fluid col-md-10 col-center-block">
    <!--最顶部导航栏 -->
    <div class="row">
        <div class="col-md-12 column">
            <nav class="navbar navbar-default" role="navigation">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#"><strong>SQL编辑界面</strong></a>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="panel panel-info">
                <div class="panel-heading">
                    SQL内容
                </div>
                <div class="panel-body" style="padding: 0">
                    <div class="row">
                        <div class="col-lg-12">
                            <textarea id="sql_value" name="sql_value" class="form-control" style="height: 474px;border: 0px;resize: none">{{ work_info.sql_value }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="panel panel-warning">
                <div class="panel-heading">
                    工单详情
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form id="sql_work_update_form">
                                <div class="form-group">
                                    <label id="user_name_lable" name="user_name_lable" class="control-label" for="user_name">标题:</label>
                                    <input id="title" type="text" name="title" class="form-control" value="{{ work_info.title }}">
                                </div>
                                <div class="form-group">
                                    <label id="user_password_lable" name="user_password_lable" class="control-label" for="user_password">jira地址:</label>
                                    <input id="jira_url" type="text" name="jira_url" class="form-control" value="{{ work_info.jira_url }}">
                                </div>
                                <div class="form-group" hidden>
                                    <label id="host_id" name="host_id" class="control-label">{{ work_info.host_id }}</label>
                                </div>
                                <div class="form-group">
                                    <label id="email_lable" name="email_lable" class="control-label" for="email">请选择是否要备份:</label>
                                    <select id="is_backup" name="is_backup" class="selectpicker show-tick form-control bs-select-hidden" required>
                                        <option value="0" {% if(work_info.is_backup == 0) %} selected {% endif %}>否</option>
                                        <option value="1" {% if(work_info.is_backup == 1) %} selected {% endif %}>是</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label id="sleep_lable" name="sleep_lable" class="control-label" for="sleep_time">请选择执行每条SQL要暂停的秒数:</label>
                                    <select id="sleep_time" name="sleep_time" class="selectpicker show-tick form-control bs-select-hidden" required>
                                        <option value="0">0</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                        <option value="24">24</option>
                                        <option value="25">25</option>
                                        <option value="26">26</option>
                                        <option value="27">27</option>
                                        <option value="28">28</option>
                                        <option value="29">29</option>
                                        <option value="30">30</option>
                                        <option value="31">31</option>
                                        <option value="32">32</option>
                                        <option value="33">33</option>
                                        <option value="34">34</option>
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                        <option value="46">46</option>
                                        <option value="47">47</option>
                                        <option value="48">48</option>
                                        <option value="49">49</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label id="audit_user_lable" name="audit_user_lable" class="control-label" for="audit_user_tmp">请选择审核用户:</label>
                                    <select id="audit_user_tmp" name="audit_user_tmp" class="selectpicker show-tick form-control bs-select-hidden" required>
                                        {% for info in audit_user_infos %}
                                            <option value="{{ info.user_id }}" {% if(work_info.audit_user_id == info.user_id) %} selected {% endif %}>{{ info.chinese_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label id="email_lable" name="email_lable" class="control-label" for="email">请选择执行SQL的DBA:</label>
                                    <select id="dba_user_id" name="dba_user_id" class="selectpicker show-tick form-control bs-select-hidden" required>
                                        {% for info in dba_users %}
                                            <option value="{{ info.user_id }}" {% if(work_info.execute_user_id == info.user_id) %} selected {% endif %}>{{ info.chinese_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% if(work_info.status == 0 or work_info.status == 2) %}
        <div class="row">
            <div class="col-md-8">
                <button class="btn btn-default" onclick="get_audit_info_for_edit()">重新审核SQL</button>
                <button class="btn btn-primary" onclick="update_sql_work({{ work_info.id }})">保存工单</button>
            </div>
        </div>
        </br>
    {% endif %}

    <div class="row">
        <div class="col-md-12" id="audit_info"></div>
    </div>

    <div class="modal fade" id="loading" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop='static'>
        <div class="modal-dialog" role="document" style="width: 600px">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="exampleModalLabel">提示</h4>
                </div>
                <div class="modal-body">
                    请稍候。。。
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script type="text/javascript">
    $(".selectpicker").selectpicker({liveSearch: true});
    var sleep_time = {{ work_info.sleep }};
    $("#sleep_time").val([sleep_time]).trigger("change");


    var json_obj = new Object();
    json_obj.sql = $("#sql_value").val();
    json_obj.host_id = "{{ work_info.mysql_host_id }}";
    json_obj.db_name = "{{ work_info.execute_db_name }}";

    function update_sql_work(sql_id) {
        var json_parameter = get_form_json($("#sql_work_update_form"));
        json_parameter.sql_id = sql_id;
        json_parameter.host_id = json_obj.host_id;
        json_parameter.db_name = json_obj.db_name;
        json_parameter.sql_value = $("#sql_value").val();
        console.log(json_parameter);
        post_request("/work/update/sql/save", JSON.stringify(json_parameter));
    }

    function get_audit_info_for_edit() {
        json_obj.sql = $("#sql_value").val();
        input_data_for_post_loding("/audit/check", JSON.stringify(json_obj), "#audit_info");
    }

    input_data_for_post_loding("/audit/check", JSON.stringify(json_obj), "#audit_info");
</script>